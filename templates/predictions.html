{% extends "base.html" %}

{% block title %}Predictions - {{ player[0] }} - Game Week {{ game_week }}{% endblock %}

{% block content %}
<a href="{{ url_for('home') }}" class="back-link">‚Üê Back to Home</a>

<div class="card">
    <h2 style="margin-bottom: 20px; color: #38003c;">
        üìä {{ player[0] }}'s Predictions - Game Week {{ game_week }}
    </h2>
    
    {% if matches %}
    <form action="{{ url_for('submit_predictions') }}" method="post">
        <input type="hidden" name="player_id" value="{{ player_id }}">
        <input type="hidden" name="game_week" value="{{ game_week }}">
        
        {% for match in matches %}
        <div class="match-card">
            <div class="match-info">
                <div class="match-teams">
                    {{ match[1] }} vs {{ match[2] }}
                </div>
                <div class="match-date">
                    {{ match[3][:16] if match[3] else 'TBD' }} UTC
                </div>
                {% if match[4] == 'FINISHED' %}
                    <div style="color: #28a745; font-weight: bold; margin-top: 5px;">
                        ‚úÖ Final Result: {{ match[5] if match[5] else 'Unknown' }}
                        {% if match[6] is not none and match[7] is not none %}
                            ({{ match[6] }} - {{ match[7] }})
                        {% endif %}
                    </div>
                {% elif match[4] in ['LIVE', 'IN_PLAY', 'PAUSED'] %}
                    <div style="color: #dc3545; font-weight: bold; margin-top: 5px;">
                        üî¥ Match Live
                    </div>
                {% endif %}
            </div>
            
            <div class="prediction-options">
                {% set current_prediction = predictions.get(match[0]) %}
                {% set is_live_or_finished = match[4] in ['LIVE', 'IN_PLAY', 'PAUSED', 'FINISHED'] %}
                
                <input type="radio" name="prediction_{{ match[0] }}" id="home_{{ match[0] }}" value="HOME" 
                       {% if current_prediction == 'HOME' %}checked{% endif %}
                       {% if is_live_or_finished %}disabled{% endif %}>
                <label for="home_{{ match[0] }}" {% if is_live_or_finished %}style="opacity: 0.5; cursor: not-allowed;"{% endif %}>{{ match[1] }} Win</label>
                
                <input type="radio" name="prediction_{{ match[0] }}" id="draw_{{ match[0] }}" value="DRAW"
                       {% if current_prediction == 'DRAW' %}checked{% endif %}
                       {% if is_live_or_finished %}disabled{% endif %}>
                <label for="draw_{{ match[0] }}" {% if is_live_or_finished %}style="opacity: 0.5; cursor: not-allowed;"{% endif %}>Draw</label>
                
                <input type="radio" name="prediction_{{ match[0] }}" id="away_{{ match[0] }}" value="AWAY"
                       {% if current_prediction == 'AWAY' %}checked{% endif %}
                       {% if is_live_or_finished %}disabled{% endif %}>
                <label for="away_{{ match[0] }}" {% if is_live_or_finished %}style="opacity: 0.5; cursor: not-allowed;"{% endif %}>{{ match[2] }} Win</label>
            </div>

            {% if is_live_or_finished %}
                <div style="margin-top: 8px; font-size: 12px; color: #dc3545; font-weight: 500; text-align: center;">
                    {% if match[4] == 'FINISHED' %}
                        ‚ö†Ô∏è Match finished - predictions locked
                    {% else %}
                        üî¥ Match live - predictions locked
                    {% endif %}
                </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" class="btn" style="font-size: 18px; padding: 15px 40px;">
                üéØ Submit All Predictions
            </button>
        </div>
    </form>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No matches found for Game Week {{ game_week }}</h3>
        <p>Matches may not be available yet or there was an error loading them.</p>
        <a href="{{ url_for('home') }}" class="btn" style="margin-top: 20px;">Go Back</a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.querySelector('button[type="submit"]');
    
    if (!form || !submitBtn) return;
    
    // Check if all predictions are made
    function checkAllPredictions() {
        const matchCards = document.querySelectorAll('.match-card');
        let totalMatches = 0;
        let predictedMatches = 0;
        let hasEnabledMatches = false;
        
        matchCards.forEach(card => {
            const radios = card.querySelectorAll('input[type="radio"]:not(:disabled)');
            if (radios.length > 0) {
                hasEnabledMatches = true;
                totalMatches++;
                const checked = card.querySelector('input[type="radio"]:checked');
                if (checked) {
                    predictedMatches++;
                }
            }
        });
        
        // Update button text and state
        if (totalMatches > 0) {
            submitBtn.textContent = `üéØ Submit Predictions (${predictedMatches}/${totalMatches})`;
        } else if (!hasEnabledMatches) {
            submitBtn.textContent = 'üîí All Matches Locked';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
        }
        
        return predictedMatches > 0;
    }
    
    // Add event listeners to radio buttons
    document.querySelectorAll('input[type="radio"]:not(:disabled)').forEach(radio => {
        radio.addEventListener('change', checkAllPredictions);
    });
    
    // Initial check
    checkAllPredictions();
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        const enabledRadios = document.querySelectorAll('input[type="radio"]:not(:disabled)');
        const checkedRadios = document.querySelectorAll('input[type="radio"]:checked:not(:disabled)');
        
        if (enabledRadios.length === 0) {
            e.preventDefault();
            alert('All matches are locked. No predictions can be submitted.');
            return;
        }
        
        if (checkedRadios.length === 0) {
            e.preventDefault();
            alert('Please make at least one prediction before submitting.');
            return;
        }
        
        const confirmed = confirm(`Are you sure you want to submit ${checkedRadios.length} prediction(s)?`);
        if (!confirmed) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}